# D05\_SimpleDocker genevaja

## Part 1. Готовый докер
- Взятие официального докер образа с nginx и загрузка его при помощи docker pull
 
Для начала надо посмотреть, какие образы доступны в репозиториях docker. Это делается при помощи команды `docker search nginx`
![Поиск образа в репозиториях docker](./image/part_1.0_search_image.png "Поиск образа в репозитории")
Для работы мы берём официальный образ nginx и используем команду `docker pull nginx`
![Загрузка образа из репозитория docker](./image/part_1.0_pull_image.png "Загрузка образа из репозитория docker")
- Проверить наличие докер образа через `docker images`
![Проверка наличия образа](./image/part_1.0_check_image.png "Проверка наличия образа")

- Запустить докер через `docker run -d [image_id|repository]`

Флаг -d для команды run запускает контейнер в фоновом режиме. После запуска выводится container ID
![Запуск контейнера](./image/part_1.0_run_nginx.png "Запуск контейнера в фоновом режиме")

- Проверить, что докер запустился при помощи команды `docker ps`

По-умолчанию имена контейнерам назначаются автоматически. Используя флаг `-name=CONTAINER'S_NAME` можно назначать любое произвольное имя
![Проверка запущенных процессов докера](./image/part_1.0_docker_ps.png "Проверка запущенных процессов докера")
- Посмотреть информацию о контейнере через `docker inspect [container_id|container_name]`
![Проверка информации о контейнере](./image/part_1.0_docker_inspect.png "Проверка информации о контейнере")
- По выводу команды опредедить размер контейнера, список портов и ip контейнера

Для того, чтобы отчёт inspect показывал в выводе размер контейнера его надо запускать с флагом -е `docker -e inspect [container_id|container_name]`
Размер контейнера: 141560660 В (135 МВ)
Список портов: 80/tcp
IP контейнера: 172.17.0.2
![Вывод grep](./image/part_1.0_docker_inspect_1.png "Вывод grep для отчёта по ключевым словам")

- Остановить докер образ через `docker stop [container_id|container_name]`

Для остановки контейнера не обязательно указывать container_id полностью. На скриншоте вывод двух команд `docker stop` и `docker ps`
![Остановка запущенного контейнера по его id](./image/part_1.0_docker_stop.png "Остановка запущенного контейнера по его id и проверка, что он остановился")
- Запустить докер с назначенными портами 80 и 445 на локальную машину через команду run

Для запуска контейнера с назначенными портами используется флаг -p. Команда имеет следующий вид `docker run -p 80:80/tcp -p 443:443/tcp -d nginx`
![Запуск контейнера с назначенными портами](./image/part_1.0_run_ports.png "Запуск контейнера с назначенными портами и выводом docker ps")
![Проверка стартовой страницы nginx](./image/part_1.0_nginx_startpage.png "Проверка стартовой страницы nginx")
- Перезапустить контейнер через `docker restart [container_id|container_name]

В случае успешного перезапуска STATUS обнуляется и отсчитывает с нуля
![Перезапуск контейнера с последующим выводом docker ps](./image/part_1.0_docker_restart.png "Перезагрузка контейнера с последующим выводом docker ps")
## Part 2. Операции с контейнером
- Прочитать конфигурационный файл nginx.conf внутри докер образа

Для вывода информации использовалась команда `docker exec CONT_ID cat /etc/nginx/nginx.conf`
![Вывод файла nginx.conf](./image/part_2.0_nginx_conf.png "Вывод файла nginx.conf")

- Создать файл nginx.conf и настроить в нём по пути /status отдачу страницы статуса сервера nginx

Настройки для отображения тех или иных страниц определяются директивой `server { location /PAGE {}}`. 
Локальные настройки для сервера складываются в папку /etc/nginx/conf.d, которая подключена директивой `include PATH` в основном файле конфигурации /etc/nginx/nginx.conf.
Для отображения страницы /status в файл /etc/nginx/conf.d/default.conf был добавлен блок `location /status { stub_status; }`. 

Используемые команды:

`docker cp CONT_NAME:/etc/nginx/conf.d/default.conf ./` - копирую файл с настройками по-умолчанию на локальную машину

`docker exec CONT_NAME rm /etc/nginx/conf.d/default.conf` - удаляю файл с настройками по-умолчанию в контейнере

`docker cp nginx.conf CONT_NAME:/etc/nginx/conf.d/nginx.conf` - копирую файл с добавленной директивой stub_status в /etc/nginx/conf.d/

`docker exec CONT_NAME nginx -s reload`

![Проверка доступности страницы localhost/status](./image/part_2.0_stub_page.png "Проверка доступности страницы localhost/status")

![Содержимое файла nginx.conf](./image/part_2.0_nginx_conf_after.png "Содержимое файла nginx.conf")

- Экспортировать контейнер в файл container.tar через команду `export`

![Экспорт контейнера в tar файл](./image/part_2.0_export.png "Экспорт контейнера в tar файл")

- Остановить контейнер

![Остановка контейнера](./image/part_2.0_stopped.png "Остановка контейнера")

- Удалить образ через `docker rmi [image_id], не удаляя перед этим контейнеры

Для удаления образа без удаления контейнера возможно с использованием флага `-f` (force).
`docker rmi -f nginx`
![Удаление образа](./image/part_2.0_rmi.png "Удаление образа")

- Удалить остановленный контейнер

Для удаления контейнера использовал команду `docker rm -f CONT_NAME`
![Удаление контейнера](./image/part_2.0_rm_cont.png "Удаление контейнера")

- Импортировать контейнер обратно через команду import, запустить контейнер и сервер

`cat container.tar | docker import - REPOSITORY_NAME:TAG` - Сначала считываем содержимое архива и перенаправляем вывод. REPOSITORY_NAME:TAG позволяет установить название для репозитория и тэг.

`docker run -it -d -p 80:80/tcp -p 443:443/tcp --name part2 [image_id] /bin/bash` - Запускаем контейнер с перенаправлением портов и оболочкой по-умолчанию

`docker exec part2 service nginx start` - запускаем nginx на сервере
![Скрин с выводом команд для запуска контейнера из архива](./image/part_2.0_import.png "Вывод команд для запуска контейнера из арзива")

- Проверить, что по адресу localhost:80/status отдаётся страничка со статусом сервера nginx
![Статусная страница](./image/part_2.0_stub_page.png "Страница со статусом")

## Part 3. Мини веб-сервер

- Исходный код мини-сервера
![Исходный код мини-сервера](./image/part_3.0_server.png "Исходный код мини-сервера")

- Содержимое файла nginx.conf

Так как стандартный файл `/etc/nginx/nginx.conf` включает в себя диррективу подключения папки `/etc/nginx/conf.d/` я дописал модуль для упраления сервером без необходимости править стартовый файл.
* listen localhost 81 - указываем, по какому порту слушаем запрос
* location / - Определить URL для родительского сервера
* include fastcgi - подключаем модуль fastcgi
* Проксируем запрос, полученный на 81 порт на указанный адрес и номер порта
![nginx.conf](./image/part_3.0_nginx.png "nginx.conf")

- Запуск fastcgi сервера
* `spawn-fcgi -a 127.0.0.1 -p 8080 -f ./a.out` - запуск сервера на ip 127.0.0.1 и 8080 порте. Флаг -f указывает file, который надо запустить
* После запуска ему присвается номер и процесс работает в фоновом режиме
![Запуск сервера](./image/part_3.0_spawn.png "Запуск сервера и отображение списка процессов")

- Запуск nginx
* Сервер запускается командой `sudo service nginx start`
* Измененные настройки применяются командой `nginx -s reload`

- ![Финальный результат](./image/part_3.0_final.png "Итоговая страница Hello, world")

## Part 4. Свой докер.

- Для запуска docker build и запуска контейнера написан скрипт `part.sh`
- Для остановки контейнера и удаления образа написан скрипт `stop_cont.sh`

## Part 5. Dockle

- Для установки Dockle воспользовался инструкцией из официального репозитория
- При первом запуске столкнулся со следующей ошибкой:
  ![Dockle error](./image/part_5.png "Ошибка Dockle при первом запуске")
- Для решения проблемы пришлось использовать следующий метод:
  * Создал учётную запись на [Docker home page](https://www.docker.com)
  * Залогинился через терминал, используя команду `docker login`
  * Запушил образ `docker push REPOSITORY_NAME`
  * И только после этого запустил `dockle REPOSITORY_NAME`
- Вывод dockle после первой проверки образа
![Dockle output](./image/part_5.1.png "Вывод dockle после первой проверки образа")
- Вывод dockle после добавления пользователя, от которого будет запускаться сервер:
![Dockle output](./image/part_5.2.png "Вывод dockle после исправления предупреждений")

## Part 6. Базовый Docker Compose

- Для выполнения задания требуется уствновить docker-compose
- Команда для запуска yml файла docker-compose build
- Для запуска готового образа используется команда docker-compose up -d (флаг -d для запуска в фоновом режиме)
![Docker compose](./image/part_6.png "Запуск образа")
